---
title: "eConsent Training Tracking"
author: "JP Giliberto MD"
format: dashboard

---

```{r}
library(tidyverse)
library (lubridate)
library(gt)
library(scales)
library(rjson)
library(readxl)

Provider_Training_Distribution <- read_excel("Provider Training Distribution.xlsx")
filenamescon <- list.files("C:/Users/jpgil/OneDrive/Documents/R/eConsent/exports", pattern="*.xlsx", full.names=TRUE)
completed<- read_excel(filenamescon)

training_data <- Provider_Training_Distribution |> 
  left_join(completed) |> 
  mutate(Completed = !is.na(ID))


 # this should give you a character vector, with each file name represented by an entry
```

# Completion Rates

## Row - Badges {height=20%}

```{r}
#| content: valuebox
#| title: "Total Completion Rate"

total_rate <- training_data |> 
  summarise(Total_Completion_Rate = round(sum(Completed)/n(), 3))
list(icon = "bookmark-check-fill",
     color = "success",
     value = percent(pull(total_rate,1),accuracy = 0.1)
)
```

```{r} 
#| content: valuebox
#| title: "Last Updated"

Update <- training_data |> 
  summarise(last_update = format(max(`Completion time`, na.rm = T),"%m/%d")) 

numby =pull(Update,1)

list(
  icon = "calendar",
  color = "primary",
  value = numby
)

```

## Row - Completion Rates by Specialty {height = 80%}

```{r}
#|title: "Total Completion Rate by Specialty"

completion_rates <- training_data |> 
  group_by(Department) |> 
  summarise(Completed = round(sum(Completed)/n(), 3))

ggplot(completion_rates, aes(x = reorder(Department, Completed),
                             y = Completed, 
                             label = percent(Completed, accuracy = 0.1), 
                             color = Completed, 
                             fill=Completed)) +
  geom_col() +
  geom_text(nudge_y = 0.019, color = "black")+
  scale_color_continuous(type = "viridis")+
  scale_fill_continuous(type = "viridis")+
  coord_flip()+
  xlab("Specialty")+
  ylab("Percent Completed")

```

# Comments

```{r}
comment_list <- training_data |> 
  select(Email, questions = `Questions about eConsent process:`) |> 
  filter(!is.na(questions))

no_comments <- comment_list |> 
  mutate(Question = str_to_sentence(questions)) |> 
  mutate(No_Qs = str_starts(Question,"No")) |> 
  filter(No_Qs ==T)

```

## Row - Badges {height=20%}

```{r}
#| content: valuebox
#| title: "Number of No/None Q"

total_no_comm <- no_comments |> 
  summarise(Number = sum(No_Qs))

list(icon = "ban",
     color = "danger",
     value = pull (total_no_comm,1)
)
```

```{r} 
#| content: valuebox
#| title: "Last Updated"

total_other_comm <- comment_list |>
  mutate(Question = str_to_sentence(questions)) |> 
  mutate(No_Qs = str_starts(Question,"No")) |> 
  filter(No_Qs ==F) |> 
  summarise(Number = n())

list(icon = "card-checklist",
     color = "success",
     value = pull (total_other_comm,1))


```

## Row - Comment details {height=80%}

```{r}
#| title: "Details of No/None Q"

total_no_comm_details <- no_comments |> 
  group_by(Question) |> 
  count() 

total_no_comm_details <- as.data.frame(total_no_comm_details)

total_no_comm_details |> 
  rename(Response = Question)|> 
  gt()
```

```{r}
#| title: "Details of Questions"

comm_details <- comment_list |> 
  mutate(Question = str_to_sentence(questions)) |> 
  mutate(No_Qs = str_starts(Question,"No")) |> 
  filter(No_Qs ==F) |> 
  left_join(training_data) |> 
  select(Name, Email, Question) |> 
  gt()

comm_details
  
```